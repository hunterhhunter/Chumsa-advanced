import esbuild from "esbuild";
import process from "process";
import fs from "fs/promises"; // manifest.json ë³µì‚¬ë¥¼ ìœ„í•´ ë‚¨ê²¨ë‘¡ë‹ˆë‹¤.
import 'dotenv/config';

const banner =
`/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
`;

const vaultPluginPath = process.env.OBSIDIAN_PLUGIN_PATH;

if (!vaultPluginPath) {
  console.error("Error: OBSIDIAN_PLUGIN_PATH environment variable is not set. Please create a .env file.");
  process.exit(1);
}

const prod = (process.argv[2] === "production");

// [ìˆ˜ì •] esbuild contextë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
const context = await esbuild.context({
  banner: { js: banner },
  entryPoints: ["src/main.ts"],
  bundle: true,
  external: ["obsidian"],
  format: "cjs",
  target: "es2020",
  logLevel: "info",
  sourcemap: prod ? false : "inline",
  treeShaking: true,
  // [í•µì‹¬ ìˆ˜ì •] outfile ê²½ë¡œë¥¼ Vault í”ŒëŸ¬ê·¸ì¸ í´ë”ë¡œ ì§ì ‘ ì§€ì •í•©ë‹ˆë‹¤.
  outfile: `${vaultPluginPath}/main.js`,
  platform: 'node',
  define: {
    'process.env.OPENAI_API_KEY': JSON.stringify(process.env.OPENAI_API_KEY)
  }
});

// manifest.jsonê³¼ styles.cssëŠ” ë¹Œë“œì™€ ë³„ê°œë¡œ ë³µì‚¬í•©ë‹ˆë‹¤.
async function copyStaticFiles() {
  try {
    await fs.copyFile("manifest.json", `${vaultPluginPath}/manifest.json`);
    await fs.copyFile("styles.css", `${vaultPluginPath}/styles.css`);
    console.log("âœ… Static files (manifest, styles) copied to vault.");
  } catch (e) {
    // styles.cssê°€ ì—†ëŠ” ê²ƒì€ ê´œì°®ìŠµë‹ˆë‹¤.
    if (e.code !== 'ENOENT' || !e.path.includes('styles.css')) {
      console.error("Error copying static files:", e);
    }
  }
}

// ë¹Œë“œ ë˜ëŠ” ê°ì‹œ ëª¨ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
if (prod) {
  await context.rebuild();
  await copyStaticFiles(); // í”„ë¡œë•ì…˜ ë¹Œë“œ í›„ í•œ ë²ˆ ë³µì‚¬
  console.log("Production build complete.");
  await context.dispose();
} else {
  // ê°ì‹œ ëª¨ë“œ ì‹œì‘ ì „, ë¨¼ì € í•œ ë²ˆ ë¹Œë“œí•˜ê³  íŒŒì¼ì„ ë³µì‚¬í•©ë‹ˆë‹¤.
  await context.rebuild();
  await copyStaticFiles();
  
  await context.watch();
  console.log("ğŸ‘€ Watching for changes...");
  
  // (ì„ íƒì‚¬í•­) manifest.jsonì´ë‚˜ styles.css íŒŒì¼ ë³€ê²½ë„ ê°ì‹œí•˜ë ¤ë©´
  // chokidar ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ê°„ë‹¨í•œ fs.watchë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
}